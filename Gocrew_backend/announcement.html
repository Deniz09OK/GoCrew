<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annonce publique - Kanban</title>cement-chat-form button:hover { background: #ff6300; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/welcome.html" class="btn-back">‚Üê Retour accueil</a>
    <h1 id="annTitle">Annonce</h1>
    <div class="meta" id="annMeta"></div>
    <div id="annDesc"></div>
    <div class="kanban-board" id="kanbanBoard"></div>

    <!-- Chat de l'annonce (public, tout le monde peut parler) -->
    <div id="announcement-chat">
      <h2>üí¨ Chat de l'annonce</h2>
      <div id="announcement-chat-messages"></div>
      <form id="announcement-chat-form" autocomplete="off">
        <input id="announcement-chat-input" type="text" placeholder="Votre message..." autocomplete="off">
        <button type="submit">Envoyer</button>
      </form>
    </div>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let crew_id = null;
    let lists = ['todo', 'doing', 'done'];
    let announcement = null;

    async function fetchAnnouncement() {
      const match = window.location.pathname.match(/\/announcement\/(\d+)/);
      const id = match ? match[1] : null;
      if (!id) return null;
      try {
        const res = await fetch('/api/announcements');
        if (!res.ok) throw new Error();
        const anns = await res.json();
        return anns.find(a => String(a.id) === String(id));
      } catch {
        return null;
      }
    }

    async function fetchTasks() {
      if (!crew_id) return [];
      const res = await fetch(`/api/tasks?crew_id=${crew_id}`);
      if (!res.ok) return [];
      return await res.json();
    }

    function getAllLists(tasks) {
      const set = new Set(lists);
      tasks.forEach(t => set.add(t.status));
      return Array.from(set);
    }

    // Drag & Drop logic
    let draggedTaskId = null;
    function dragStart(e) {
      draggedTaskId = this.dataset.id;
      setTimeout(() => this.style.display = "none", 0);
    }
    function dragEnd(e) {
      this.style.display = "";
      draggedTaskId = null;
    }

    function editTaskPrompt(task) {
      const title = prompt('Titre de la t√¢che', task.title);
      if (title === null) return;
      const description = prompt('Description', task.description || '');
      if (description === null) return;
      fetch(`/api/tasks/${task.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, description })
      }).then(() => loadKanban());
    }

    function renderKanban(tasks) {
      lists = getAllLists(tasks);
      const board = document.getElementById('kanbanBoard');
      board.innerHTML = '';
      lists.forEach(list => {
        const col = document.createElement('div');
        col.className = 'kanban-column';
        col.id = list;

        // Titre de la liste
        const titleDiv = document.createElement('div');
        titleDiv.style.position = 'relative';
        titleDiv.innerHTML = `<h2>${list}</h2>`;
        col.appendChild(titleDiv);

        // Liste des t√¢ches
        const tasksDiv = document.createElement('div');
        tasksDiv.className = 'tasks';
        tasks.filter(t => t.status === list).forEach(task => {
          const div = document.createElement('div');
          div.className = 'task';
          div.draggable = true;
          div.dataset.id = task.id;
          div.innerHTML = `
            <strong>${task.title}</strong><br>${task.description || ''}
            <button class="edit-task" title="Modifier">‚úèÔ∏è</button>
            <button class="delete-task" title="Supprimer">üóëÔ∏è</button>
          `;
          // Drag events
          div.addEventListener('dragstart', dragStart);
          div.addEventListener('dragend', dragEnd);
          // Delete task
          div.querySelector('.delete-task').onclick = async function(e) {
            e.stopPropagation();
            await fetch(`/api/tasks/${task.id}`, { method: 'DELETE' });
            loadKanban();
          };
          // Edit task
          div.querySelector('.edit-task').onclick = function(e) {
            e.stopPropagation();
            editTaskPrompt(task);
          };
          tasksDiv.appendChild(div);
        });
        col.appendChild(tasksDiv);

        // Formulaire d'ajout de t√¢che
        const form = document.createElement('form');
        form.className = 'add-task-form';
        form.dataset.status = list;
        form.innerHTML = `
          <input type="text" name="title" placeholder="Titre" required>
          <textarea name="description" placeholder="Description"></textarea>
          <button type="submit">Ajouter</button>
        `;
        form.onsubmit = async function(e) {
          e.preventDefault();
          const title = form.title.value;
          const description = form.description.value;
          await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ crew_id, title, description, status: list })
          });
          form.reset();
          loadKanban();
        };
        col.appendChild(form);

        board.appendChild(col);
      });

      // Drag & drop listeners sur les colonnes (toujours apr√®s render)
      document.querySelectorAll('.kanban-column .tasks').forEach(col => {
        col.ondragover = function(e) {
          e.preventDefault();
          this.classList.add('drag-over');
        };
        col.ondragleave = function(e) {
          this.classList.remove('drag-over');
        };
        col.ondrop = async function(e) {
          e.preventDefault();
          this.classList.remove('drag-over');
          if (!draggedTaskId) return;
          const parentCol = this.closest('.kanban-column');
          const newStatus = parentCol.id;
          // Met √† jour le statut c√¥t√© backend
          await fetch(`/api/tasks/${draggedTaskId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });
          loadKanban();
        };
      });
    }

    async function loadKanban() {
      if (!crew_id) return;
      const tasks = await fetchTasks();
      renderKanban(tasks);
    }

    async function loadAnnouncement() {
      announcement = await fetchAnnouncement();
      if (!announcement) {
        document.getElementById('annTitle').textContent = "Annonce introuvable";
        return;
      }
      document.getElementById('annTitle').textContent = announcement.title;
      document.getElementById('annMeta').textContent =
        `Destination : ${announcement.destination || 'inconnue'} | Crew : ${announcement.crew_id} | Publique`;
      document.getElementById('annDesc').textContent = announcement.description || '';
      crew_id = announcement.crew_id;
      loadKanban();
    }

    loadAnnouncement();

    // --- Chat de l'annonce ---
    const socket = io();
    const annChatMessages = document.getElementById('announcement-chat-messages');
    const annChatForm = document.getElementById('announcement-chat-form');
    const annChatInput = document.getElementById('announcement-chat-input');
    const gocrewUsername = localStorage.getItem('gocrew_username') || 'Anonyme';

    // R√©cup√®re l'id de l'annonce
    function getAnnouncementId() {
      const match = window.location.pathname.match(/\/announcement\/(\d+)/);
      return match ? match[1] : null;
    }
    const announcementId = getAnnouncementId();

    // Rejoint le salon de l'annonce (public)
    socket.on('connect', () => {
      socket.emit('join-announcement-chat', { announcementId });
    });

    // Affiche un message dans le chat
    function appendAnnMessage(msg) {
      const div = document.createElement('div');
      div.textContent = `[${msg.time || new Date().toLocaleTimeString()}] ${msg.user || 'Anonyme'}: ${msg.text}`;
      annChatMessages.appendChild(div);
      annChatMessages.scrollTop = annChatMessages.scrollHeight;
    }

    // Historique du chat
    socket.on('chat-history-announcement', msgs => {
      annChatMessages.innerHTML = '';
      msgs.forEach(appendAnnMessage);
    });

    // R√©ception des messages
    socket.on('chat-message-announcement', appendAnnMessage);

    // Envoi d'un message
    annChatForm.onsubmit = e => {
      e.preventDefault();
      const text = annChatInput.value.trim();
      if (!text) return;
      socket.emit('chat-message-announcement', { announcementId, text, user: gocrewUsername });
      annChatInput.value = '';
    };
  </script>
</body>
</html>
